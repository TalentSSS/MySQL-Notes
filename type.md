# 3 数据类型

MySQL里的每一个数值都拥有一个类型，37.4、'abc'

使用CREATE TABLE语句建表时，就必须为这个表里的每个列定义一种类型

```mysql
CREATE TABLE mytbl
{
	int_col		INT,		# 整数值列
	str_col		CHAR(20),	# 字符串值列
	date_col 	DATE		# 日期值列
};
```

看似普通的操作中几乎都隐藏着数据类型的概念

```mysql
INSERT INTO mytbl(int_col, str_col, date_col)
VALUES(14, CONCAT('a', 'b'), 20130815);
```

这条语隐含着丰富的数据类型信息

* 把整数`14`赋值给整型列`int_col`
* 把字符串`'a'`和`'b'`传递给字符串拼接函数`CONCAT()`，然后将返回的字符串值`'ab'`赋给字符串列`str_col`
* 把整数值`20130815`赋值给日期列`date_col`，这里出现了类型不匹配的问题，但整数值可以解释为日期值，MySQL会进行自动类型转换

有必要透彻了解MySQL是如何处理数据。

## 3.1 数据值类别

MySQL支持多种常规类别的数据值，数值、字符串值、日期/时间(时态值)、空间值、NULL值

### 3.1.1 数值

48、193.62、-2.378E12之类的值。

#### 3.1.1.1 精确值数和近似值数

MySQL支持对精确值数的精确计算，以及对近似值数的近似运算。

整数可以表示成十进制或者十六进制两种格式。十进制整数由一个不含小数点的数字序列构成。十进制值会被默认为字符串，但在数值计算的时候，十六进制常量会被视为64位整数。

小数部分的精确值由3个部分组成：一个数字序列、一个小数点和另一个数字序列。

近似值采用科学计数法表示的浮点数，有一个底数、一个指数，1.58E5、-1.58E5、1.58E-5、-1.58E-5。

**十六进制数不能用科学计数法**。

精确值计算结果也是精确的，只要没超出精度范围，就不会丢失精度。

近似值计算是近似的，会有舍入误差。

MySQL按照如下规则确定表达式使用精确计算还是近似计算

* 表达式有近似值，就被当成浮点数（近似值）算
* 有整数精确值，就用BIGINT(64位)精度计算
* 只包含精确值，但有小数部分，就以具有65位精度的DECIMAL算法来进行计算
* 如果必须将字符串转换为一个数才能算，那字符串会被转化为双精度浮点值。然后按照前面的规则做近似计算

#### 3.1.1.2 位域值(BIT值)

b'val'或0bval，val由一个或多个二进制(0或1)构成，b'1001'或0b1001表示十进制9。

BIT值会被显示为一个二进制串，不过输出不友好。

使用+0或CAST转化为一个整数

```mysql
mysql> SELECT b'1001' + 0, CAST(b'1001' AS UNSIGNED);
```

### 3.1.2 字符串值

'Madison, Wisconson'、'patient shows improvement'、'12345'

字符串两端可以是单引号也可以是双引号，尽量用单引号。

原因：

* SQL语言标准规定；能更好地移植到其他数据库引擎
* 如果用了ANSI_QUOTES模式，MySQL会将双引号处理成将标识符引起来的符号，而不会只当成字符串引起来的符号

转义字符

| 转义序列 |          含义          |
| :------: | :--------------------: |
|    \0    |     NUL(零值字节)      |
|   \\'    |         单引号         |
|   \\"    |         双引号         |
|    \b    |         退格符         |
|    \n    |         换行符         |
|    \r    |         回车符         |
|    \t    |         制表符         |
|   \\\    |         反斜线         |
|    \z    | Ctrl+Z(Windows中的EOF) |

嵌入引号的多种方法

* 用重复两次的方式嵌入引号

    ```
    'I can''t'
    "He said, ""I told you so."""
    ```

* 嵌入引号与字符串引号不同

    ```
    "I can't"
    'He said, "I told you so."'
    ```

* 对嵌入引号使用反斜线转义，不受字符串引号限制

    ```
    'I can\'t'
    "I can\'t"
    "He said, \"I told you so.\""
    'He said, \"I told you so.\"'
    ```

用双引号写字符串值，还可以用十六进制记法

* 标准的SQL记法X'val'

    val由多对十六进制数字(包括"0"~"9"和"a"~"f")组成。前导字符"X"和字符串里的十六进制数字字符("a"~"f")都不区分大小写

    ```mysql
    mysql> SELECT X'4A', x'4a';
    ```

    都输出字母`J`。

    字符串上下文中每两个十六进制数字都会被解释为一个8为数字字节值，范围是0~255。

    ```mysql
    mysql> SELECT X'61626364', X'61626364'+0;
    ```

* 以`"0x"`开头，后面跟一个或多个十六进制数字

    `x`只能是小写的，与X'val'记法相似，`0x`值会被默认解释为字符串

    ```mysql
    mysql> SELECT 0x61626364, 0x61626364+0;
    ```

#### 3.1.2.1 字符串类型与字符集支持

字符串值可以分为两类，即二进制串和非二进制串

* 二进制串是一组字节序列。对这些字节的解释不牵涉任何字符集概念，没有特殊的比较或排序属性。比较操作基于各字节的数值逐个字节实现，所有字节都有意义，包括结尾空格。
* 非二进制串，与字符集相关。字符集决定了：哪些字符能用、MySQL会如何解释字符串的内容。默认的字符集和排序规则为latin1何latin_swedish-ci。

字符单位在占用存储空间方面存在差异，即不同字符集单字符占有的字节空间不同。

用下面两条语句来看服务器上有哪些字符集，对应的排序规则是什么

```mysql
mysql> SHOW CHARACTER SET;
mysql> SHOW COLLATION;
```

从输出内容可以观察到，每种排序规则都捆绑在某个特定字符集上，每个特定字符集可以有多种排序规则。排序规则由**字符集名、语言名和一个附加的后缀构成**。

Utf8_iceland_ci，字符集utf8，iceland排序规则，case insensitive不区分大小写。

后缀的含义

* `_ci`不区分大小写
* `_cs`区分大小写
* `_bin`二进制排序规则，比较操作基于数字字符编码值进行

二进制串和非二进制串的不同排序特性

* 二进制串逐字节比较，结果取决于每个字节的数值大小
* 非二进制串按字符进行比较，相对打下取决于用的字符集排序规则

排序规则会对以下操作造成影响

* 比较运算：<、<=、=、< >、>=、>和LIKE
* 排序：ORDER BY、MIN()和MAX()。
* 分组：GROUP BY和DISTINCT

使用`CHARSET()`或`COLLATION()`来确定某个字符串的字符集合排序规则。

引号里的字符串会根据服务器的当前设置来解释。默认的字符集和排序规则分别为`latin1`和`latin1_swedish_ci`。

```mysql
mysql> SELECT CHARSET(x'0123'), COLLATION(X'0123');
```

有两种记法约定可以用于将某个字符串常量强制解释为某种指定的字符集

* _charset 记法，字符集引导符

    `_latin2 'abc'`

* N'str'

    等价于`_utf8'str'`，在N(不区分大小写)的后面必须紧跟一个引号形式的字符串，不能有任何空白

引导符记法可用于引号形式的字符串或十六进制常量，但不能用与字符串表达式或列值。可以用CONVERT()函数将任意字符串转换为另一种指定字符集形式的字符串

```mysql
CONVERT(str USING charset);
```

引导符与CONVERT()函数的不同

```mysql
mysql> SET @s1 = _ucs2 'ABCD';
mysql> SET @s2 = CONVERT('ABCD' USING ucs2);
```

假设当前字符集为`latin1`（单字节字符集）。第一条语句把字符串`'ABCD'`中的每一对字符解释为一个双字节的`ucs2`字符，结果为包含两个字符的`ucs2`字符。第二条语句把字符串`'ABCD'`中的每个字符转换为相应的`ucs2`字符，结果为包含4个字符的`ucs2`字符串。

长度有两种

* CHAR_LENGTH()函数，按照字符来测量
* LENGTH()函数，按照字节来测量

```mysql
mysql> SELECT CHAR_LENGTH(@s1), LENGTH(@s1), CHAR_LENGTH(@s2), LENGTH(@s2);
```

这里有一个非常容易弄错的问题，**二进制串与使用某种二进制排序规则的非二进制串**的区别

* 二进制串没有字符集的概念。它会被**解释为字节**，并且比较的是单字节的数字代码
* 使用了二进制排序规则的非二进制串，会被**解释成字符**，并且比较的是它们的数字字符值，这种值通常基于每个字符多个字节算出

展示二进制和非二进制串在大小写方面的区别，创建一个二进制串和一个使用了某种二进制排序规则的非二进制串，然后把它们传递给UPPER()函数

```mysql
mysql> SET @s1 = BINARY 'abcd';
mysql> SET @s2 = _latin1 'abcd' COLLATE latin1_bin;
mysql> SELECT UPPER(@s1), UPPER(@s2);
```

输出结果发现函数没有把二进制字符串转换大小写。因为二进制字符串没有字符集概念，就没有大小写概念。如果要传给UPPER()或LOWER()这样的需要指定字符集的函数，必须先转成非二进制串

```mysql
mysql> SELECT @s1, UPPER(CONVERT(@s1 USING latin1));
```

#### 3.1.2.2 字符集相关的系统变量

MySQL服务器有几个系统变量，它们设计字符集支持的各个方面。大部分与字符集有关，其余与排序规则有关。每个排序规则变量都有一个相应的字符集变量与之相连。

* 有些字符集表示的是服务器或当前数据库的属性

    character_set_system、character_set_server和collation_system、character_set_database和collation_database

* 其他的字符集变量影响客户和服务器之间的通信

    character_set_client、character_set_results、character_set_connection、character_set_filesystem

绝大多数字符集和排序规则都被默认设置成了相同的值

```mysql
mysql> SHOW VARIABLE LIKE 'character\_set\_%';
mysql> SHOW VARIABLE LIKE 'collation\_%';
```

如果某个用户客户端想用另一种字符集来与服务器通信，那就要修改与通信有关的变量，例如想用`utf8`，则需要

```mysql
mysql> SET character_set_client = utf8;
mysql> SET character_set_results = utf8;
mysql> SET character_set_connection = utf8;
```

使用SET NAMES语句可以更方便地达到同样效果。

```mysql
mysql> SET NAMES 'utf8';
```

### 3.1.3 时态(日期/时间)值

时态值包括日期值或时间值，如'2012-06-17'或'12:30:43'。

MySQL支持将日期时间合并在一起，即'2012-06-17 12:30:43'。MySQL是按照"年-月-日"的顺序来表示日期的，输入也必须是这样的顺序(标准的SQL格式)。可以利用DATE_FORMAT()函数按任意方式显示日期值。

组合后的日期时间值，允许在日期和时间之间加一个字符"T"，但不能用空格。

### 3.1.4 空间值

很少用

### 3.1.5 布尔值

表达式里，零为假，任何非零、非NULL值为真。

布尔常量TRUE和FALSE分别当做1和0，不区分大小写。

### 3.1.6 NULL值

NULL即一种没有类型的值，用来表示"无值"、"未知值"、"缺失值"、"超界"、"不适用"和"不在其中"等。可以将NULL插入表中、从表里检索、测试某个值是不是NULL。但不能对NULL进行算术运算。

使用NULL不用引号，不用区分大小写。\N(区分大小写)也当做NULL

```mysql
mysql> SELECT \N, ISNULL(\N);
```









